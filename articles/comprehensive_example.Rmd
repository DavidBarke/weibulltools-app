---
title: "Weibull Analysis with {weibulltools}"
author: 
  - "Tim-Gunnar Hensel"
  - "David Barkemeyer"
date: "16 2 2021"
output: 
  html_document
---

```{r setup, echo = FALSE, message=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  screenshot.force = FALSE,
  comment = "#>"
)
library(weibulltools)
library(dplyr)
```

TODO: Einleitender Satz
The {[weibulltools](https://github.com/Tim-TU/weibulltools/)} package includes statistical methods and visualizations that can be used in reliability engineering. This blog post shows how to use its functionality for performing the Weibull analysis on reliability data. First, we need to clarify what we mean by reliability data and Weibull analysis. Reliability data consist of a lifetime variable and a status variable. The lifetime variable can represent various characteristics influencing the reliability of a product, e.g operating time (days/months in service), mileage (km, miles) or load cycles. The status variable indicates whether a unit has failed or is non-defective (*censored*) at the observed lifetime. With the Weibull analysis we can use this reliability data to estimate the overall reliability of our product. 

For performing an introductory Weibull analysis, we will use the `shock` dataset, which is included in {weibulltools}. 

```{r}
library(weibulltools)
shock
```

In this dataset kilometer-dependent problems that have occurred on shock absorbers are reported. In addition to failed items the dataset also contains *censored* observations. The data can be found in _Statistical Methods for Reliability Data_ [^note3]. 

[^note3]: Meeker, W. Q.; Escobar, L. A.: _Statistical Methods for Reliability Data_, 
          _New York, Wiley series in probability and statistics_, 1998, p. 630
          
For consistent handling of the data, {weibulltools} introduces the function 
`reliability_data()` that converts the original dataset into a formatted object which allows to easily apply the presented methods.  

```{r dataset_shock, message = FALSE}
shock_tbl <- reliability_data(data = shock, x = distance, status = status)
shock_tbl
```

## Estimation of Failure Probabilities

First, we are interested in how censored observations influence the estimation of 
failure probabilities in comparison to the case where only failed units are considered. 
To deal with survived and failed units we will use `estimate_cdf()` with 
`methods = "johnson"`, whereas `methods = "mr"` only considers failures. 

```{r failure_probabilities}
# Estimate CDF with both methods: 
shock_cdf <- estimate_cdf(shock_tbl, methods = c("mr", "johnson"))

# First case where only failed units are taken into account:
shock_cdf_mr <- shock_cdf %>% filter(cdf_estimation_method == "mr")
shock_cdf_mr

# Second case where both, survived and failed units are considered:
shock_cdf_john <- shock_cdf %>% filter(cdf_estimation_method == "johnson") 
shock_cdf_john
```

<br>

If we compare both outputs we can see that survivors reduce the probabilities since undamaged units with longer or equal 
lifetime characteristic _x_ let us gain confidence in the product. 

## Probability Plotting

The estimated probabilities can now be presented in a probability plot. With `plot_prob()` probability plots for several lifetime distributions can be constructed and estimates of multiple methods can be displayed at once. The axes are transformed in such a way that the _cumulative distribution function (CDF)_ is represented through a straight line. If the plotted probabilities lie on an approximately straight line it can be said that the chosen distribution is adequate.

### Weibull Probability Plot

```{r probability_plot_weibull_2, fig.cap = "Figure 3: Plotting positions in Weibull grid.", message = FALSE}
# Weibull grid for estimated probabilities: 
weibull_grid <- plot_prob(
  shock_cdf,
  distribution = "weibull", 
  title_main = "Weibull Probability Plot", 
  title_x = "Mileage in km", 
  title_y = "Probability of Failure in %",
  title_trace = "Method",
  plot_method = "ggplot2"
)

weibull_grid
```

<br>

_Figure 3_ shows that the consideration of survivors (orange points, _Method: johnson_) decreases the failure probability in comparison to the sole evaluation of failed items (green points, _Method: mr_).  

### Log-normal Probability Plot

Finally, we want to use a log-normal probability plot to visualize the estimated failure probabilities.

```{r probability_plot_log-normal, fig.cap = "Figure 4: Plotting positions in log-normal grid.", message = FALSE}
# Log-normal grid for estimated probabilities: 
lognorm_grid <- plot_prob(
  shock_cdf,
  distribution = "lognormal",
  title_main = "Log-normal Probability Plot",
  title_x = "Mileage in km",
  title_y = "Probability of Failure in %",
  title_trace = "Method",
  plot_method = "ggplot2"
)

lognorm_grid
```

<br>

On the basis of _Figure 3_ and _Figure 4_ we can subjectively assess the goodness of fit of Weibull and log-normal. It can be seen that in both grids, the plotted points roughly fall on a straight line. Hence one can say that the Weibull as well as the log-normal are good model candidates for the `shock` data.

## Estimation of parametric lifetime distributions

{weibulltools} comes with two basic methods for the parameter estimation of lifetime distributions. Whereas `rank_regression()` fits a straight line through the plotting positions of the just calculated failure probabilites, `ml_estimation()` strives to maximize a function of the parameters given the sample data. After the parameters are obtained, a cumulative distribution function _(CDF)_ can be computed and added to a probability plot with `plot_mod()`. `rank_regression()` and `ml_estimation()` can be applied to complete data as well as failure and (multiple) right-censored data. Both methods can also deal with three-parametric models that include a threshold parameter $\gamma$.  

### RR for two-parameter Weibull distribution

```{r RR_weibull, fig.cap = "Figure 1: RR for a two-parametric Weibull distribution.", message = FALSE}
# Estimating two-parameter Weibull: 
rr_weibull <- rank_regression(shock_cdf, distribution = "weibull")
rr_weibull 

# Add regression line to probability plot: 
weibull_plot_rr <- plot_mod(
  weibull_grid,
  x = rr_weibull,
  title_trace = "Rank Regression"
)

weibull_plot_rr
```

### ML for two-parameter Weibull distribution

```{r ML_weibull, fig.cap = "Figure 2: ML for a two-parametric Weibull distribution.", message = FALSE}
# Again estimating Weibull: 
ml_weibull <- ml_estimation(
  shock_tbl, 
  distribution = "weibull"
)

ml_weibull 

# Add ML estimation to weibull_grid: 
weibull_plot_ml <- plot_mod(
  weibull_grid, 
  x = ml_weibull, 
  title_trace = "Maximum Likelihood"
)

weibull_plot_ml
```

# Estimation of confidence intervals
